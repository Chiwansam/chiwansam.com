<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audio + Visual Drift | Chiwansam</title>
  <meta name="description" content="Èü≥Ê•Ω„Å´Âêà„Çè„Åõ„Å¶Èùô„Åã„Å´ÂÜôÁúü„ÅåÂ∑°„Çã„ÄÅÊ≤°ÂÖ•Âûã„Çπ„É©„Ç§„Éâ„Ç∑„Éß„Éº" />
  <style>
    :root{
      --bg:#0f0f12; --ink:#eaeaf0; --muted:#a7a7b3; --accent:#b8a7ff; --line:#2a2a31;
      --maxw:1280px; --pad:16px;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic","Meiryo",sans-serif;
      overflow:hidden;
    }

    .stage{position:relative;height:100vh;width:100vw;overflow:hidden}
    .slide{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 1.8s ease}
    .slide img{width:100%;height:100%;object-fit:cover;filter:contrast(1.02) saturate(1.02)}
    .slide.active{opacity:1}
    body.playing .slide.active img{animation:ken 18s ease-in-out forwards}
    @keyframes ken{0%{transform:scale(1.03)}100%{transform:scale(1.08)}}

    /* ÈñãÂßãÂâç„Ç≤„Éº„Éà */
    #gate{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      flex-direction:column;gap:14px;background:rgba(0,0,0,.45);z-index:5;
    }
    #gate.hidden{opacity:0;pointer-events:none;transition:opacity .8s ease}
    .start{
      appearance:none;border:1px solid var(--line);background:rgba(0,0,0,.55);
      color:var(--ink);padding:10px 20px;border-radius:10px;font-size:18px;cursor:pointer;
    }
    .start:hover{background:rgba(0,0,0,.72)}
    .muted{color:var(--muted)}

    /* „Ç™„Éº„Éê„Éº„É¨„Ç§Ôºà„ÇØ„É™„ÉÉ„ÇØÈÄèÈÅéÔºâ */
    .overlay{
      position:absolute;left:0;right:0;bottom:0;
      padding:18px var(--pad) 72px;
      background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.5) 65%, rgba(0,0,0,.65) 100%);
      z-index:4;
      pointer-events:none;
    }
    .overlay .controls,
    .overlay .title,
    .overlay #now { pointer-events:auto; }

    .meta{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .title{font-weight:700}

    .controls{display:flex;align-items:center;gap:10px;margin-left:auto}
    .btn{
      appearance:none;border:1px solid var(--line);background:#17171b;color:var(--ink);
      padding:8px 10px;border-radius:10px;cursor:pointer;
    }
    .btn:hover{border-color:#3a3a44}

    /* „Éâ„ÉÉ„ÇØÔºà„Ç≥„É≥„Éà„É≠„Éº„É´„Éê„ÉºÔºâ */
    .dock{
      position:absolute;left:0;right:0;bottom:0;max-width:var(--maxw);
      margin:0 auto;padding:8px 12px;display:flex;align-items:center;gap:10px;
      background:transparent;border-top:none;
      opacity:0;transform:translateY(8px);
      transition:opacity .25s ease, transform .25s ease;
      z-index:6;
      pointer-events:auto;
    }
    .dock.show{opacity:1;transform:none;}

    .progress{
      position:relative;flex:1;min-width:220px;height:4px;
      background:rgba(255,255,255,.18);
      border-radius:999px;overflow:hidden;
      pointer-events:auto;
    }
    .bar{position:absolute;left:0;top:0;bottom:0;width:0;background:var(--accent)}

    .vol{display:flex;align-items:center;gap:8px}
    input[type=range]{accent-color:var(--accent);pointer-events:auto;}

    audio::-webkit-media-controls-panel,
    audio::-webkit-media-controls-enclosure{display:none!important;visibility:hidden!important;opacity:0!important}
    audio{width:0;height:0;opacity:0;position:absolute;pointer-events:none}
  </style>
</head>
<body>
  <section class="stage" aria-live="polite" aria-label="„Çπ„É©„Ç§„Éâ„Ç∑„Éß„Éº">
    <div class="slide" id="s0"><img alt="" /></div>
    <div class="slide" id="s1"><img alt="" /></div>
    <div id="gate">
      <button id="start" class="start">‚ñ∂ Start</button>
      <div class="muted" style="font-size:13px">ÈñãÂßã„Åô„Çã„Å®Èü≥Ê•Ω„Å®„Çπ„É©„Ç§„Éâ„ÅåÊµÅ„Çå„Åæ„Åô</div>
    </div>
    <div class="overlay">
      <div class="meta">
        <div class="title" id="trackTitle">‚Äî</div>
        <div class="muted" id="now">Now Playing</div>
        <div class="controls">
          <button id="prev" class="btn" title="Ââç„ÅÆÊõ≤">‚ü®‚ü®</button>
          <button id="play" class="btn" title="ÂÜçÁîü">‚ñ∂</button>
          <button id="pause" class="btn" title="‰∏ÄÊôÇÂÅúÊ≠¢">‚è∏</button>
          <button id="next" class="btn" title="Ê¨°„ÅÆÊõ≤">‚ü©‚ü©</button>
        </div>
      </div>
    </div>
  </section>
  <div class="dock">
    <div class="progress" aria-label="ÈÄ≤Ë°åÁä∂Ê≥Å"><div class="bar" id="prog"></div></div>
    <div class="time muted" id="time">0:00 / 0:00</div>
    <div class="vol">
      <button id="mute" class="btn" title="„Éü„É•„Éº„ÉàÂàáÊõø">üîà</button>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.85" aria-label="Èü≥Èáè">
    </div>
  </div>
  <audio id="audio" preload="auto" hidden></audio>

  <script>
  const DATA_URL = '/assets/av.json';
  const FALLBACK = { playlist:[ { title:'Sample Track', music:'https://cdn.pixabay.com/download/audio/2021/09/16/audio_1.mp3?filename=sample-3s.mp3', images:[ 'https://picsum.photos/seed/av1/1600/900', 'https://picsum.photos/seed/av2/1600/900', 'https://picsum.photos/seed/av3/1600/900' ], interval: 4000 } ] };

  const el={
    slides:[document.getElementById('s0'),document.getElementById('s1')],
    img0:document.querySelector('#s0 img'),
    img1:document.querySelector('#s1 img'),
    gate:document.getElementById('gate'),
    start:document.getElementById('start'),
    title:document.getElementById('trackTitle'),
    btnPrev:document.getElementById('prev'),
    btnPlay:document.getElementById('play'),
    btnPause:document.getElementById('pause'),
    btnNext:document.getElementById('next'),
    prog:document.getElementById('prog'),
    time:document.getElementById('time'),
    volume:document.getElementById('volume'),
    mute:document.getElementById('mute'),
    audio:document.getElementById('audio'),
    dock:document.querySelector('.dock')
  };

  let data=FALLBACK,idxTrack=0,idxImg=0,timer=null,showing=0,loaded=false;

  function preload(u){u.forEach(x=>{const i=new Image();i.src=x;});}
  function hms(s){if(!isFinite(s))return'0:00';const m=Math.floor(s/60),sec=Math.floor(s%60);return`${m}:${String(sec).padStart(2,'0')}`;}
  function setProgress(){
    const a=el.audio,p=(a.currentTime/(a.duration||1))*100;
    el.prog.style.width=p+'%';
    el.time.textContent=`${hms(a.currentTime)} / ${hms(a.duration)}`;
  }
  function swapSlide(nextUrl){
    const next=(showing^1);
    const img=el.slides[next].querySelector('img');
    img.src=nextUrl;
    el.slides[next].classList.add('active');
    el.slides[showing].classList.remove('active');
    showing=next;
  }
  function startSlideshow(track){
    clearInterval(timer);
    const images=track.images||[];
    if(!images.length)return;
    idxImg=0;showing=0;
    el.img0.src=images[0];
    el.slides[0].classList.add('active');
    el.slides[1].classList.remove('active');
    preload(images);
    timer=setInterval(()=>{
      idxImg=(idxImg+1)%images.length;
      swapSlide(images[idxImg]);
    },Math.max(2500,track.interval||5000));
  }
  function primeFirstFrame(){
    const list=data.playlist||[data];
    const t=list[0]||{};
    const imgs=t.images||[];
    if(imgs.length){el.img0.src=imgs[0];el.slides[0].classList.add('active');}
  }
  function loadTrack(i){
    const list=data.playlist||[data];
    idxTrack=(i+list.length)%list.length;
    const t=list[idxTrack];
    el.title.textContent=t.title||'Untitled';
    el.audio.src=t.music;
    el.audio.play().catch(()=>{});
    startSlideshow(t);
    document.body.classList.add('playing');
  }

  el.audio.addEventListener('timeupdate',setProgress);
  el.audio.addEventListener('ended',()=>loadTrack(idxTrack+1));

  el.btnPrev.addEventListener('click',()=>loadTrack(idxTrack-1));
  el.btnNext.addEventListener('click',()=>loadTrack(idxTrack+1));
  el.btnPlay.addEventListener('click',()=>{el.audio.play();document.body.classList.add('playing');});
  el.btnPause.addEventListener('click',()=>{el.audio.pause();document.body.classList.remove('playing');});
  el.volume.addEventListener('input',()=>{el.audio.volume=parseFloat(el.volume.value);});
  el.mute.addEventListener('click',()=>{el.audio.muted=!el.audio.muted;el.mute.textContent=el.audio.muted?'üîá':'üîà';});
  document.querySelector('.progress').addEventListener('click',e=>{
    const r=e.currentTarget.getBoundingClientRect();
    const ratio=(e.clientX-r.left)/r.width;
    el.audio.currentTime=ratio*(el.audio.duration||0);
  });

  (async function init(){
    try{
      const r=await fetch(DATA_URL,{cache:'no-cache'});
      data=r.ok?await r.json():FALLBACK;
    }catch{data=FALLBACK;}
    loaded=true;
    primeFirstFrame();
    showDock(); // ÂàùÊúüË°®Á§∫„Åß„Éâ„ÉÉ„ÇØË°®Á§∫
  })();

  el.start.addEventListener('click',()=>{
    el.gate.classList.add('hidden');
    if(!loaded){primeFirstFrame();}
    loadTrack(0);
  });

  // „Éâ„ÉÉ„ÇØË°®Á§∫„ÅÆ„Éà„É™„Ç¨„Éº
  let dockTimer=null;
  function showDock(){
    el.dock.classList.add('show');
    clearTimeout(dockTimer);
    dockTimer=setTimeout(()=>el.dock.classList.remove('show'),2200);
  }
  ['mousemove','touchstart','mouseenter'].forEach(ev=>window.addEventListener(ev,showDock));
  el.dock.addEventListener('mouseenter',showDock);
  el.dock.addEventListener('mousemove',showDock);
  [el.btnPrev,el.btnPlay,el.btnPause,el.btnNext,el.volume,el.mute].forEach(x=>x&&x.addEventListener('click',showDock));

  window.addEventListener('keydown',e=>{
    if(e.key===' '){
      e.preventDefault();
      if(el.audio.paused){el.btnPlay.click();}
      else{el.btnPause.click();}
    }else if(e.key==='ArrowRight'){el.btnNext.click();}
    else if(e.key==='ArrowLeft'){el.btnPrev.click();}
    showDock();
  });
  </script>
</body>
</html>
