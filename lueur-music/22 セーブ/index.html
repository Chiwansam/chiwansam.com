<!doctype html>

<!--
  lueur-music
  Chiwansam.com
-->

<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lueur de Chiwan</title>
  <meta name="description" content="Èü≥„Å®ÂÖâ„Åå„ÇÜ„Çã„ÇÑ„Åã„Å´‰∫§„Çè„ÇãÈùô„Åã„Å™„Çπ„É©„Ç§„Éâ„Ç∑„Éß„Éº" />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#000; --ink:#eaeaf0; --muted:#a7a7b3; --accent:#b8a7ff;
      --maxw:1280px; --pad:16px; --toph:56px; --both:88px;
    }
    html,body{
      height:100%;margin:0;
      background:#0b0b0d;color:var(--ink);
      font-family:'Cormorant Garamond',serif;
      overflow:hidden;
    }

    /* „Çπ„É©„Ç§„ÉâË°®Á§∫ */
    .stage{position:relative;height:100vh;width:100vw;overflow:hidden;background:#000}
    .slide{position:absolute;left:0;right:0;top:var(--toph);bottom:var(--both);
      display:flex;align-items:center;justify-content:center;
    }
    .slide img{width:100%;height:100%;object-fit:contain;background:#000;opacity:1;transition:opacity 2s ease}

    /* ‰∏ä‰∏ãÈªíÂ∏Ø */
    .topbar{position:absolute;left:0;right:0;top:0;height:var(--toph);
      display:flex;align-items:center;justify-content:space-between;
      background:#000;padding:0 var(--pad);z-index:6;
      border-bottom:1px solid rgba(255,255,255,.06)}
    .topbar .title{font-weight:700;margin-left:16px;font-size:25px;}
    .topbar .brand{opacity:.9;margin-right:16px;}
    .topbar .brand a{color:var(--ink);text-decoration:none;font-size:30px;}

    .bottombar{position:absolute;left:0;right:0;bottom:0;height:var(--both);
      display:flex;align-items:center;gap:12px;background:#000;
      padding:12px var(--pad);z-index:6;
      border-top:1px solid rgba(255,255,255,.06);
      box-sizing:border-box;flex-wrap:nowrap;}
    .bottombar > *{flex:0 0 auto;}
    .controls{display:flex;align-items:center;gap:10px;}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.2);
      background:#17171b;color:var(--ink);
      padding:8px 12px;border-radius:10px;cursor:pointer;
    }
    .btn:hover{border-color:rgba(255,255,255,.35);}
    .progress{position:relative;flex:1 1 auto;min-width:240px;height:6px;
      background:rgba(255,255,255,.18);border-radius:999px;overflow:hidden;cursor:pointer;
      touch-action:none;}
    .bar{position:absolute;left:0;top:0;bottom:0;width:0;background:var(--accent);}
    .time{min-width:92px;white-space:nowrap;color:var(--muted);font-variant-numeric:tabular-nums;}
    .vol{display:flex;align-items:center;gap:8px;}
    input[type=range]{accent-color:var(--accent);}

    #tap{position:absolute;left:0;right:0;top:var(--toph);bottom:var(--both);z-index:3}

    /* Gate overlay */
    #gate {
      position:absolute;inset:var(--toph) 0 var(--both) 0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:100px;z-index:7;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.25);
      padding:48px 72px;
      backdrop-filter:blur(4px);
      box-shadow:0 0 40px rgba(0,0,0,0.4);
      transition:opacity .7s ease;
    }
    #gate.hidden{opacity:0;pointer-events:none}
    .logoTitle{
      font-weight:500;letter-spacing:.05em;color:#f3f3f3;
      font-size:clamp(28px,6vw,100px);margin:0;text-align:center;
      opacity:0;transform:translateY(10px);animation:fadeUp .8s ease forwards;
      text-shadow:0 0 18px rgba(255,255,255,0.3),2px 4px 6px rgba(0,0,0,0.5);
      margin-top:0.9em;
    }
    @keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
    audio{display:none}

    /* Play button */
    .play {
      display:inline-flex;align-items:center;gap:0.4em;
      font-family:'Cormorant Garamond',serif;
      font-size:2.2rem;color:#eaeaf0;opacity:0.8;
      transition:opacity 0.3s;cursor:pointer;
      margin-top:1.4em;
    }
    .play span{letter-spacing:0.05em;}
    .play:hover{opacity:1;}
    .play:hover svg{stroke:#fff;}
    .play:hover span{color:#fff;opacity:1;}

    /* „Ç≠„É£„Éó„Ç∑„Éß„É≥ÔºàÈáçË§áÂÆöÁæ©„Çí1„Å§„Å´Áµ±ÂêàÔºâ */
    .caption {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      display: inline-block;
      max-width: min(90%, 900px);
      text-align: left;

      font-size: 30px;
      line-height: 1.4;
      color: #f2f2f7;
      white-space: pre-wrap;
      text-shadow:
        0 0 6px rgba(0,0,0,0.6),
        0 2px 4px rgba(0,0,0,0.8);

      opacity: 1;
      transition: opacity 1s ease; /* „Éï„Çß„Éº„Éâ 1Áßí */
    }

    /* Áä∂ÊÖã„Éò„É´„Éë„ÉºÔºàJS„Åß‰ªò„ÅëÂ§ñ„ÅóÔºâ */
    .is-hidden { opacity: 0 !important; }
    .is-visible { opacity: 1 !important; }
  </style>
</head>
<body>
  <section class="stage">
    <div class="topbar">
      <div class="title" id="trackTitle">‚ô© MUSIC TITLE</div>
      <div class="brand"><a href="/">Lueur de Chiwan</a></div>
    </div>

    <!-- Âçò‰∏Ä„Çπ„É©„Ç§„ÉâÈÅãÁî®„Å´Á∞°Á¥†ÂåñÔºàs0„ÅÆ„Åø‰ΩøÁî®Ôºâ -->
    <div class="slide" id="s0">
      <img id="img0" alt="">
      <div class="caption" id="cap0"></div>
    </div>

    <div id="tap" aria-hidden="true"></div>

    <div id="gate">
      <h1 class="logoTitle">Lueur de Chiwan</h1>
      <div class="play" id="btnEnter">
        <svg width="40" height="40" viewBox="0 0 14 14" fill="none" stroke="#fff" stroke-width="1.2">
          <polygon points="3,2 11,7 3,12" />
        </svg>
        <span>Enter Sound</span>
      </div>
    </div>

    <div class="bottombar">
      <div class="controls">
        <button id="prev" class="btn" title="Ââç„ÅÆÊõ≤">‚ü®‚ü®</button>
        <button id="next" class="btn" title="Ê¨°„ÅÆÊõ≤">‚ü©‚ü©</button>
      </div>
      <div class="progress"><div class="bar" id="prog"></div></div>
      <div class="time" id="time">0:00 / 0:00</div>
      <div class="vol">
        <button id="mute" class="btn" title="„Éü„É•„Éº„ÉàÂàáÊõø">üîà</button>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.85">
      </div>
    </div>
  </section>

  <audio id="audio" preload="auto"></audio>

  <script>
  const DATA_URL = `./assets/${(new URLSearchParams(location.search).get("list")||"av").replace(/[^a-z0-9_\-]/gi,"")}.json`;

  const el={
    slide:document.getElementById('s0'),
    img:document.getElementById('img0'),
    cap:document.getElementById('cap0'),
    gate:document.getElementById('gate'),
    btnEnter:document.getElementById('btnEnter'),
    tap:document.getElementById('tap'),
    title:document.getElementById('trackTitle'),
    prog:document.getElementById('prog'),
    time:document.getElementById('time'),
    volume:document.getElementById('volume'),
    mute:document.getElementById('mute'),
    audio:document.getElementById('audio'),
    btnPrev:document.getElementById('prev'),
    btnNext:document.getElementById('next'),
    progress:document.querySelector('.progress')
  };

  el.audio.volume=parseFloat(el.volume.value||0.85);

  let data=null,idxTrack=0,idxImg=0,loaded=false;
  let currentTrack=null,lastVolume=el.audio.volume;
  let runToken=null; // ÂÜçÁîü„Ç∑„Éº„Ç±„É≥„Çπ‰∏≠Êñ≠Áî®„Éà„Éº„ÇØ„É≥

  async function loadData(){
    try{
      const r=await fetch(DATA_URL+'?v='+Date.now());
      if(!r.ok)throw 0;
      const j=await r.json();
      if(!Array.isArray(j.playlist))throw 0;
      return j;
    }catch{
      return{playlist:[{title:"Sample",music:"",images:[],interval:4000}]}
    }
  }

  function normalizeImages(arr){
    return (arr||[])
      .map(x=>typeof x==="string"?{src:x,text:null}:{src:x.src,text:x.text||null})
      .filter(Boolean);
  }

  function sleep(ms){return new Promise(res=>setTimeout(res,ms));}
  function setImgVisible(v){ el.img.classList.toggle('is-hidden',!v); el.img.classList.toggle('is-visible',!!v); }
  function setCapVisible(v){ el.cap.classList.toggle('is-hidden',!v); el.cap.classList.toggle('is-visible',!!v); }

  async function runSequence(track){
    // Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥„ÇíÁô∫Ë°å„Åó„ÄÅÂè§„ÅÑ„É´„Éº„Éó„ÇíÁÑ°ÂäπÂåñ
    const token={alive:true};
    runToken=token;

    const imgs = track._normImages;
    if(!imgs.length) return;

    // „Çπ„ÉÜ„ÉÉ„Éó‚ë†: ÁîªÂÉè„Éª„ÉÜ„Ç≠„Çπ„Éà„Çí„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
    setImgVisible(true); // ÂàùÊúüË°®Á§∫„Åã„ÇâÁ¢∫ÂÆü„Å´1Áßí„ÅßÊ∂à„Åô„Åü„ÇÅ‰∏ÄÊó¶ÂèØË¶ñ‚ÜíÈö†„Åô
    setCapVisible(true);
    await sleep(0);
    setImgVisible(false);
    setCapVisible(false);
    await sleep(1000); // 1Áßí„ÅßÊ∂à„Åà„Çã

    // „Çπ„ÉÜ„ÉÉ„Éó‚ë°: Áúü„Å£Êöó„Åß1ÁßíÁ∂≠ÊåÅ
    await sleep(1000);

    // „Çπ„ÉÜ„ÉÉ„Éó‚ë¢: Èü≥Ê•ΩÈñãÂßãÔºàÂàùÂõû„ÅÆ„ÅøÁ¢∫ÂÆü„Å´Ôºâ
    try{ await el.audio.play(); }catch{}

    // „É°„Ç§„É≥„É´„Éº„Éó: ‚ë£„Äú‚ë™ „ÇíÂêÑÁîªÂÉè„ÅßÁπ∞„ÇäËøî„Åô
    while(token===runToken && token.alive){
      const it = imgs[idxImg];

      // Ê¨°„ÅÆÁîªÂÉè/„ÉÜ„Ç≠„Çπ„Éà„Çí„Çª„ÉÉ„ÉàÔºà„Åæ„Å†ÈùûË°®Á§∫„ÅÆ„Åæ„ÅæÔºâ
      el.img.src = it.src;
      el.cap.textContent = it.text || "";
      setImgVisible(false);
      setCapVisible(false);

      // ‚ë£ „ÉÜ„Ç≠„Çπ„Éà„Éï„Çß„Éº„Éâ„Ç§„É≥Ôºà1ÁßíÔºâ
      setCapVisible(true);
      await sleep(1000);
      if(token!==runToken||!token.alive) break;

      // ‚ë§ „Åù„ÅÆ„Åæ„Åæ2ÁßíÈñì
      await sleep(2000);
      if(token!==runToken||!token.alive) break;

      // ‚ë• ÁîªÂÉè„Éï„Çß„Éº„Éâ„Ç§„É≥Ôºà1ÁßíÔºâ
      setImgVisible(true);
      await sleep(1000);
      if(token!==runToken||!token.alive) break;

      // ‚ë¶ json„ÅÆË®≠ÂÆöÁßíÊï∞ÂæÖÊ©üÔºà„Éá„Éï„Ç©ÊúÄ‰Ωé2.5ÁßíÁ®ãÂ∫¶„Å´Ôºâ
      const iv=Math.max(0, (track.interval||4000));
      await sleep(iv);
      if(token!==runToken||!token.alive) break;

      // ‚ëß „ÉÜ„Ç≠„Çπ„Éà„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÔºà1ÁßíÔºâ
      setCapVisible(false);
      await sleep(1000);
      if(token!==runToken||!token.alive) break;

      // ‚ë® „Åù„ÅÆ„Åæ„Åæ2ÁßíÈñì
      await sleep(2000);
      if(token!==runToken||!token.alive) break;

      // ‚ë© ÁîªÂÉè„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÔºà1ÁßíÔºâ
      setImgVisible(false);
      await sleep(1000);
      if(token!==runToken||!token.alive) break;

      // ‚ë™ Áúü„Å£Êöó„Åß1Áßí ‚Üí Ê¨°„ÅÆÁîªÂÉè„Å∏
      await sleep(1000);
      idxImg = (idxImg + 1) % imgs.length;
    }
  }

  async function ensureData(){ if(!loaded){ data=await loadData(); loaded=true; } }

  function loadTrack(i){
    const list=data.playlist; idxTrack=(i+list.length)%list.length;
    const t=list[idxTrack];
    el.title.textContent=`‚ô© ${t.title||'‚Äî'}`;
    el.audio.src=t.music||"";
    el.prog.style.width='0%';
    el.time.textContent='0:00 / 0:00';

    currentTrack = t;
    currentTrack._normImages = normalizeImages(t.images);
    idxImg = 0;

    // „É´„Éº„ÉóÂÜçÈñã
    runSequence(currentTrack);
  }

  function setProgress(){
    const a=el.audio,p=(a.currentTime/(a.duration||1))*100;
    el.prog.style.width=p+'%';
    el.time.textContent=`${Math.floor(a.currentTime/60)}:${String(Math.floor(a.currentTime%60)).padStart(2,'0')} / ${Math.floor(a.duration/60)||0}:${String(Math.floor(a.duration%60)||'00').padStart(2,'0')}`;
  }

  // „Ç§„Éô„É≥„Éà
  el.audio.addEventListener('timeupdate',setProgress);
  el.audio.addEventListener('loadedmetadata',setProgress);
  el.audio.addEventListener('ended',()=>loadTrack(idxTrack+1));
  el.audio.addEventListener('play',()=>{document.body.classList.add('playing');el.gate.classList.add('hidden');});
  el.audio.addEventListener('pause',()=>{document.body.classList.remove('playing');el.gate.classList.remove('hidden'); if(runToken) runToken.alive=false;});

  if(el.volume)el.volume.addEventListener('input',()=>{const v=parseFloat(el.volume.value);el.audio.volume=v;el.audio.muted=(v===0);});
  if(el.mute)el.mute.addEventListener('click',()=>{if(!el.audio.muted){lastVolume=el.audio.volume>0?el.audio.volume:0.85;el.audio.muted=true;}else{el.audio.muted=false;el.audio.volume=lastVolume;}el.mute.textContent=el.audio.muted?'üîá':'üîà';});
  el.audio.addEventListener('volumechange',()=>{el.volume.value=el.audio.muted?0:el.audio.volume;el.mute.textContent=el.audio.muted?'üîá':'üîà';});

  if(el.progress){
    let scrub=false;
    const ratio=x=>{const r=el.progress.getBoundingClientRect();return Math.min(1,Math.max(0,(x-r.left)/r.width));};
    el.progress.addEventListener('click',e=>{el.audio.currentTime=ratio(e.clientX)*(el.audio.duration||0);});
    el.progress.addEventListener('pointerdown',e=>{scrub=true;onMove(e);});
    const onMove=e=>{if(!scrub)return;const rt=ratio(e.clientX);el.prog.style.width=(rt*100)+'%';el.audio.currentTime=rt*(el.audio.duration||0);};
    window.addEventListener('pointermove',onMove);
    window.addEventListener('pointerup',()=>scrub=false);
  }

  el.btnPrev.onclick=()=>ensureData().then(()=>loadTrack(idxTrack-1));
  el.btnNext.onclick=()=>ensureData().then(()=>loadTrack(idxTrack+1));

  // StartÔºàEnter SoundÔºâ„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆ„Éï„É≠„Éº
  const startFlow = async ()=>{
    await ensureData();
    if(!data.playlist.length) return;
    loadTrack(0); // Èü≥Ê∫ê„Çª„ÉÉ„Éà + „Ç∑„Éº„Ç±„É≥„ÇπÈñãÂßãÔºàrunSequenceÂÜÖ„Åß‚ë¢ÂÜçÁîü‚Üí‚ë£‰ª•ÈôçÔºâ
    el.gate.classList.add('hidden');
  };

  el.btnEnter.addEventListener('click', startFlow);
  el.tap.addEventListener('click', ()=>{ if(el.audio.paused){ startFlow(); } else { el.audio.pause(); } });

  // ÂàùÊúüÁä∂ÊÖã: ÁîªÂÉè/„Ç≠„É£„Éó„Ç∑„Éß„É≥„ÅØË¶ã„Åõ„Å¶„Åä„Åç„ÄÅÈñãÂßãÊôÇ„Å´‚ë†„ÅßÊ∂à„Åó„Å¶Èªí„Å´ËêΩ„Å®„Åô
  (async()=>{
    data = await loadData();
    loaded = true;
    const t = data.playlist[0] || {images:[]};
    const imgs = normalizeImages(t.images);
    if(imgs.length){
      el.img.src = imgs[0].src;
      el.cap.textContent = imgs[0].text || '';
      setImgVisible(true);
      setCapVisible(true);
    }
  })();
  </script>
</body>
</html>
